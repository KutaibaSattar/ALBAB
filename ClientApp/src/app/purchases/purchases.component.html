<!-- HEADER -->
<header id="main-header" class="bg-secondary text-white ">
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <h1>
          <i class="fa fa-shopping-basket"></i> Purchases</h1>
      </div>
    </div>
  </div>
</header>

<!-- SEARCH -->
<section id="search" class="py-1 mb-2 bg-light">
  <div class="container">
    <div class="row">
      <div class="col-md-6 ml-auto">
        <div class="input-group ">
          <input type="text" class="form-control" placeholder="Search Invoice..." [matAutocomplete]="auto"
                 name="joke" #joke="ngModel" [(ngModel)]="txtSearchInv" (ngModelChange)="doFilter()">
          <mat-autocomplete (optionSelected)="OnHumanSelected($event.option)" #auto="matAutocomplete" [displayWith]="PurchNameFn.bind(this)">
            <mat-option *ngFor="let purch of this.filteredPurchNos$| async" [value]="purch.id">
              {{purch.purNo}}
            </mat-option>
          </mat-autocomplete>


          <div class="input-group-append">
            <button class="fa fa-search ml-1 btn btn-success" (click)="getPurch()" > Search</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div *ngIf="purchInv"  class="container">
  <form [formGroup]="formInvoice" (ngSubmit)="OnSubmit()" (keydown.enter)="$event.preventDefault()">
    <div class="row">
      <!--  -->
      <div class="col-md-3">

        <div class="form-group">
          <label >Purch No</label>
          <div class="input-group">
            <span class="input-group-append input-group-text">#</span>
            <input name="purNo" formControlName="purNo" class="form-control"
              [ngClass]="{'is-invalid': purNo.invalid &&  purNo.touched }">
            <span *ngIf="purNo.invalid &&  purNo.touched && purNo.errors.required"
              class="ml-0 input-group-append invalid-feedback">Please enter invoice No</span>


          </div>
        </div>
      </div>
      <div class="col-md-3">
        <label >Date</label>
        <input type="date" name="purNo" formControlName="purDate" class="form-control"
        [ngClass]="{'is-invalid': purDate.invalid &&  purDate.touched }">

          <span *ngIf="purDate.invalid && purDate.touched && purDate.errors.required"
          class="ml-0 input-group-append invalid-feedback">Please enter a valid date</span>
      </div>
      <div class="col-6">
        <div class="form-group">
          <label >Supplier</label>
          <div class="input-group ">
            <!-- <input type="text" class="form-control" matInput formControlName="appUserId" [matAutocomplete]="customers"
              placeholder="Customer" [ngClass]="{'is-invalid': appUserId.invalid &&  appUserId.touched}">
            <mat-autocomplete (optionSelected)="OnHumanSelected($event.option)" #customers="matAutocomplete"
              [displayWith]="displayFn.bind(this)">
              <mat-option *ngFor="let option of filteredUsers$ | async" [value]="option.id">
                {{option.displayName}} - {{option.userId}}
              </mat-option>
            </mat-autocomplete> -->
            <app-dropown-template class="col-12" [listsFilter]= members [controlName] ="appUserId"  ></app-dropown-template>
            <span
              *ngIf="appUserId.invalid &&  appUserId.touched && (appUserId.errors.required || appUserId.errors.shouldLimited) "
              class="ml-0 input-group-append invalid-feedback">Please enter a valid product</span>
          </div>

        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="form-group">
          <label>Payment Method</label>
          <select name="pMethod" class="form-control">
            <option value="">-Select-</option>
            <option value="Cash">Cash</option>
            <option value="Cheque">Cheque</option>
            <option value="Card">Card</option>
          </select>
        </div>
      </div>
          <div class="col-md-6">
            <label >Grand Total</label>
            <div class="input-group">
              <div class="input-group-prepend">

                <div class="input-group-text">AED</div>

              </div>

              <input name="gtotal" [formControl] = 'grdTotal'   class="form-control" readonly>

            </div>
            </div>




    </div>



    <header id="main-header" class="bg-secondary text-white ">
      <div class="container">
        <div class="row pb-2 pt-1">
          <div class="col-md-12">
            <button class="fa fa-plus-circle btn btn-success float-left" type="button"  (click)="addRecord()"> Add </button>
                    <button class="fa fa-save btn btn-success ml-2 float-left" type="submit"> Save</button>
                    <button class="fa fa-edit btn btn-success ml-2 float-left" type="button" (click)="NewInv()"> New</button>
                    <button class="fa fa-edit btn btn-danger ml-2 float-left" type="button" (click)="deleteInv()" > Delete</button>
                    <button class=" fa fa-search-minus btn btn-secondary float-right" type="button" (click)="AddOrEditPurchseItem(purchInv)"> Search</button>
          </div>
        </div>
      </div>
    </header>

    <ng-container formArrayName="invDetails">

      <!-- Table Header -->
      <table class="table table-bordered table-dark table-hover table-sm table-condensed">
           <thead class="thead-light">

          <tr>
            <th style="width: 30%">Item</th>
            <th style="width: 10%">Price</th>
            <th style="width: 10%">Quantity</th>
            <th style="width: 10%">Total</th>
            <th style="width: 10%">Action</th>



          </tr>
        </thead>
        <!-- Table Body -->
          <tbody *ngFor="let section of getSections(formInvoice); let i = index" >
                <tr [formGroupName]="i">
                  <td>
                    <input  type="text" class="form-control" matInput formControlName="productId" [matAutocomplete]="products"
                      placeholder="New item">
                    <mat-autocomplete (optionSelected)="OnHumanSelected($event.option)" #products="matAutocomplete" [displayWith]="ProductNameFn.bind(this)">
                      <mat-option *ngFor="let option of filteredItems$[i] | async" [value]="option.id">
                        {{option.name}}
                      </mat-option>
                    </mat-autocomplete>
                  </td>
                   <td> <input type="number" class="form-control" placeholder="Price" formControlName="price"  > </td>
                  <td> <input type="number" class="form-control" placeholder="Quantity"  formControlName="quantity" ></td>
                  <td> <input type="number" class="form-control" placeholder="UnitTotal"  formControlName="unitTotalPrice" ></td>
                  <td>  <button class="fa fa-save btn btn-danger mt-1" ng-really-message="Are you sure?" type="button" (click)="removeUnit(i)"> Delete</button></td>



                </tr>
          </tbody>
      </table>
    </ng-container>
        <pre>{{formInvoice.value | json}}</pre>




    <div class="form-group">

    </div>

  </form>

</div>
